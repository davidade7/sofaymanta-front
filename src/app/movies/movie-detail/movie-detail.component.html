<div class="movie-detail-container">
  <div class="back-button-container">
    <button (click)="goBack()" class="back-button">
      <lucide-icon [img]="ArrowLeft"></lucide-icon> Volver
    </button>
  </div>

  <div *ngIf="loading" class="loading-container">
    <p>Cargando...</p>
  </div>

  <div *ngIf="error" class="error-container">
    <p class="error-message">{{ error }}</p>
    <button (click)="goBack()" class="back-button">Volver</button>
  </div>

  <div *ngIf="movie && !loading && !error" class="movie-content">
    <div class="movie-backdrop" [style.background-image]="movie.backdrop_path ? 'url(https://image.tmdb.org/t/p/w1280' + movie.backdrop_path + ')' : 'none'">
      <div class="backdrop-overlay"></div>
    </div>

    <div class="movie-info-container">
      <div class="movie-poster">
        <img [src]="'https://image.tmdb.org/t/p/w500' + movie.poster_path" [alt]="movie.title">
      </div>

      <div class="movie-info">
        <h1 class="movie-title">{{ movie.title }}</h1>
        <p *ngIf="movie.tagline" class="movie-tagline">{{ movie.tagline }}</p>

        <div class="movie-stats">
          <div class="movie-rating">
            <lucide-icon [img]="Star" class="text-yellow-500"></lucide-icon> {{ movie.vote_average?.toFixed(1) || 'N/A' }}
            <span class="vote-count">({{ movie.vote_count || 0 }} votos)</span>
          </div>
          <div class="movie-runtime">{{ movie.runtime }} min</div>
          <div class="movie-year">{{ movie.release_date ? (movie.release_date | date:'yyyy') : 'N/A' }}</div>
        </div>

        <div class="movie-genres">
          <h3>Géneros</h3>
          <div class="genre-tags">
            <span *ngFor="let genre of movie.genres" class="genre-tag">
              {{ genre.name }}
            </span>
          </div>
        </div>

         <div class="user-interaction-section" *ngIf="currentUser">
          <h3>Tu evaluación</h3>
          <div class="interaction-content">
            <div *ngIf="userInteraction" class="existing-interaction">
              <div class="user-rating" *ngIf="userInteraction.rating">
                <lucide-icon [img]="Star" class="text-yellow-500"></lucide-icon>
                <span>{{ userInteraction.rating }}/10</span>
              </div>
              <div class="user-comment" *ngIf="userInteraction.comment">
                <lucide-icon [img]="MessageSquare" size="16"></lucide-icon>
                <p>{{ userInteraction.comment }}</p>
              </div>
              <button class="edit-rating-btn" (click)="openRatingModal()">
                Editar evaluación
              </button>
            </div>
            <div *ngIf="!userInteraction" class="no-interaction">
              <p>¿Qué te pareció esta película?</p>
              <button class="rate-movie-btn" (click)="openRatingModal()">
                <lucide-icon [img]="Star" size="16"></lucide-icon>
                Evaluar película
              </button>
            </div>
          </div>
        </div>

        <div class="movie-overview">
          <h3>Synopsis</h3>
          <p>{{ movie.overview }}</p>
        </div>

        <div class="additional-info">
          <div class="info-grid">
            <h3 class="label">Presupuesto:</h3>
            <p>{{ movie.budget | currency:'USD':'symbol':'1.0-0' }}</p>
          </div>
          <div class="info-grid">
            <h3 class="label">Ingresos:</h3>
            <p>{{ movie.revenue | currency:'USD':'symbol':'1.0-0' }}</p>
          </div>
          <div class="info-grid">
            <h3 class="label">Idioma original:</h3>
            <p>{{ getLanguageName(movie.original_language) }}</p>
          </div>
          <div class="info-grid">
            <h3 class="label">Países de producción:</h3>
            <div class="country-tags">
              <span *ngFor="let country of movie.production_countries" class="genre-tag">
                {{ country.name }}
              </span>
            </div>
          </div>
        </div>

        <div class="movie-companies" *ngIf="movie.production_companies && movie.production_companies.length > 0">
          <h3>Compañías de producción</h3>
          <div class="company-list">
            <div *ngFor="let company of movie.production_companies" class="company-item">
              <img *ngIf="company.logo_path" [src]="'https://image.tmdb.org/t/p/w92' + company.logo_path" [alt]="company.name">
              <span>{{ company.name }}</span>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Rating Modal -->
  <app-rating-modal
    *ngIf="showRatingModal && movie && currentUser"
    [mediaId]="movie.id"
    [mediaType]="'movie'"
    [mediaTitle]="movie.title"
    [userId]="currentUser.id"
    [existingInteraction]="userInteraction"
    (closeModalEvent)="closeRatingModal()"
    (interactionSaved)="onInteractionSaved($event)"
  ></app-rating-modal>
</div>
